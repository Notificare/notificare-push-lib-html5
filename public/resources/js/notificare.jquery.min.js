/*! Notificare 2016-10-24 */
!function(a,b,c,d){function e(b,c){this.element=b,this.options=a.extend({},g,c),this.init()}var f="notificare",g={sdkVersion:"1.9.1",websitePushUrl:"https://push.notifica.re/website-push/safari",fullHost:b.location.protocol+"//"+b.location.host,wssUrl:"wss://websocket.notifica.re",protocols:["notificare-push"],daysToExpire:"30",clientInfo:new UAParser,userId:null,username:null};e.prototype={init:function(){this.placeholder=a(c.createElement("div")),this.placeholder.addClass("notificare"),this.uniqueId=this._getUniqueID(),this.sessionDate=new Date,this.reconnectTimeout=0,this.minReconnectTimeout=1e3,this.maxReconnectTimeout=6e4,this.allowedNotifications=!1,this.safariPush=!1,this.chromePush=!1,"undefined"!=typeof Storage&&(localStorage.getItem("regions")||localStorage.setItem("regions",JSON.stringify([])),localStorage.getItem("position")||localStorage.setItem("position",JSON.stringify({latitude:0,longitude:0})),localStorage.getItem("badge")||localStorage.setItem("badge",0)),"undefined"!=typeof NOTIFICARE_PLUGIN_OPTIONS?(this.options=a.extend({},g,NOTIFICARE_PLUGIN_OPTIONS),this.options.useTestEnv?(this.options.apiUrl="https://cloud-test.notifica.re/api",this.options.awsStorage="https://push-test.notifica.re/upload"):(this.options.apiUrl="https://cloud.notifica.re/api",this.options.awsStorage="https://push.notifica.re/upload"),this._getApplicationInfo()):this._initWithConfig(function(b){this.options=a.extend({},g,b),this.options.useTestEnv?(this.options.apiUrl="https://cloud-test.notifica.re/api",this.options.awsStorage="https://push-test.notifica.re/upload"):(this.options.apiUrl="https://cloud.notifica.re/api",this.options.awsStorage="https://push.notifica.re/upload"),this._getApplicationInfo()}.bind(this),function(a){console.warn("Notificare: Please make sure you have a config.json file in the root of your webapp")}.bind(this))},_handleSession:function(){a(b).bind("focus",function(a){this.sessionDate=new Date,this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.application.Open",userID:this.options.userId||null,deviceID:this._getCookie("uuid")||null},function(a){},function(a){})}.bind(this)).bind("blur",function(a){var b=new Date,c=this.sessionDate,d=c.getTime()-b.getTime(),e=d/1e3,f=Math.abs(e);this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.application.Close",userID:this.options.userId||null,deviceID:this._getCookie("uuid")||null,data:{length:f}},function(a){console.log("Notificare: Session:"+f+" seconds")},function(a){})}.bind(this))},registerForNotifications:function(){var c=!1;if(this.options.appHost.indexOf("localhost")>-1?c=!0:this.options.appHost.indexOf("https")>-1&&(c=!0),this.applicationInfo.websitePushConfig&&this.applicationInfo.websitePushConfig.icon&&this.applicationInfo.websitePushConfig.allowedDomains.length>0&&a.inArray(this.options.fullHost,this.applicationInfo.websitePushConfig.allowedDomains)>-1)if("safari"in b&&"pushNotification"in b.safari&&this.applicationInfo.websitePushConfig&&this.applicationInfo.websitePushConfig.info&&this.applicationInfo.websitePushConfig.info.subject&&this.applicationInfo.websitePushConfig.info.subject.UID){var d=b.safari.pushNotification.permission(this.applicationInfo.websitePushConfig.info.subject.UID);"default"==d.permission?b.safari.pushNotification.requestPermission(this.options.websitePushUrl,this.applicationInfo.websitePushConfig.info.subject.UID,{applicationKey:this.options.appKey},function(b){b.deviceToken&&(this.allowedNotifications=!0,this.safariPush=!0,a(this.element).trigger("notificare:didReceiveDeviceToken",b.deviceToken),this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.application.Install"},function(a){},function(a){}))}.bind(this)):"denied"==d.permission?this.options.allowSilent&&this._setSocket():"granted"==d.permission&&(this.allowedNotifications=!0,this.safariPush=!0,a(this.element).trigger("notificare:didReceiveDeviceToken",d.deviceToken))}else navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&"serviceWorker"in navigator&&"showNotification"in ServiceWorkerRegistration.prototype&&"PushManager"in b&&c&&this.options.serviceWorker&&this.options.serviceWorkerScope&&this.applicationInfo.websitePushConfig&&this.applicationInfo.websitePushConfig.info&&this.applicationInfo.websitePushConfig.info.subject&&this.applicationInfo.websitePushConfig.info.subject.UID?navigator.serviceWorker.register(this.options.serviceWorker,{scope:this.options.serviceWorkerScope}).then(function(){navigator.serviceWorker.onmessage=function(a){var b=a.data.split(":");if(b&&b.length>1)switch(b[0]){case"notificationclick":this._handleClickOnChromeNotification(b[1]);break;case"notificationreceived":this._getChromeNotification(b[1]);break;case"notificationreplied":var c=b[1].split("|");this._handleActionClickOnChromeNotification(c[0],c[1]);break;case"workeractivated":this._sendMessage({action:"init",options:this.options})}}.bind(this),navigator.serviceWorker.ready.then(function(b){b.pushManager.getSubscription().then(function(c){if(!c)return void b.pushManager.subscribe({name:"push",userVisibleOnly:!0}).then(function(b){d=this._getPushToken(b),this.allowedNotifications=!0,this.chromePush=!0,a(this.element).trigger("notificare:didReceiveDeviceToken",d),this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.application.Install"},function(a){},function(a){})}.bind(this))["catch"](function(a){"denied"===Notification.permission?this.options.allowSilent&&this._setSocket():setTimeout(function(){this.registerForNotifications()}.bind(this),2e3)}.bind(this));var d=this._getPushToken(c);this.allowedNotifications=!0,this.chromePush=!0,a(this.element).trigger("notificare:didReceiveDeviceToken",d)}.bind(this))["catch"](function(a){setTimeout(function(){this.registerForNotifications()}.bind(this),2e3)}.bind(this))}.bind(this))}.bind(this))["catch"](function(a){setTimeout(function(){this.registerForNotifications()}.bind(this),2e3)}.bind(this)):b.Notification?"default"===Notification.permission?Notification.requestPermission(function(){this.allowedNotifications=!0,this._setSocket()}.bind(this)):"granted"===Notification.permission?(this.allowedNotifications=!0,this._setSocket()):"denied"===Notification.permission?this.options.allowSilent&&this._setSocket():this.options.allowSilent&&this._setSocket():b.webkitNotifications?0==b.webkitNotifications.checkPermission()?(this.allowedNotifications=!0,this._setSocket()):b.webkitNotifications.requestPermission(function(a){1==b.webkitNotifications.checkPermission()?this.options.allowSilent&&this._setSocket():2==b.webkitNotifications.checkPermission()?this.options.allowSilent&&this._setSocket():(this.allowedNotifications=!0,this._setSocket())}.bind(this)):navigator.mozNotification?0==navigator.mozNotification.checkPermission()?(this.allowedNotifications=!0,this._setSocket()):navigator.mozNotification.requestPermission(function(a){1==navigator.mozNotification.checkPermission()?this.options.allowSilent&&this._setSocket():2==navigator.mozNotification.checkPermission()?this.options.allowSilent&&this._setSocket():(this.allowedNotifications=!0,this._setSocket())}.bind(this)):this.options.allowSilent&&this._setSocket();else this.log("Notificare: Please check your Website Push configurations in our dashboard before proceed")},userId:function(a){return a?void(this.options.userId=a):this.options.userId},username:function(a){return a?void(this.options.username=a):this.options.username},badge:function(){return localStorage.getItem("badge")},log:function(a){console.log(a)},_getUniqueID:function(){var a=(new Date).getTime();return a},_setCookie:function(a){var b=new Date;b.setDate(b.getDate()+this.options.daysToExpire);var d=escape(a)+(null==this.options.daysToExpire?"":"; expires="+b.toUTCString());c.cookie="uuid="+d},_getCookie:function(a){var b=c.cookie,d=b.indexOf(" "+a+"=");if(-1==d&&(d=b.indexOf(a+"=")),-1==d)b=null;else{d=b.indexOf("=",d)+1;var e=b.indexOf(";",d);-1==e&&(e=b.length),b=unescape(b.substring(d,e))}return b},_reconnect:function(){this.reconnectTimeout=2*this.reconnectTimeout,this.reconnectTimeout<this.minReconnectTimeout?this.reconnectTimeout=this.minReconnectTimeout:this.reconnectTimeout>this.maxReconnectTimeout&&(this.reconnectTimeout=this.maxReconnectTimeout),this.log("Reconnection in "+this.reconnectTimeout+" milliseconds"),setTimeout(function(){this._setSocket()}.bind(this),this.reconnectTimeout)},_setSocket:function(){if("WebSocket"in b){var c=new WebSocket(this.options.wssUrl,this.options.protocols);c.onopen=function(){this._getCookie("uuid")?c.send(JSON.stringify({command:"register",uuid:this._getCookie("uuid")})):(this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.application.Install"},function(a){},function(a){}),c.send(JSON.stringify({command:"register"})))}.bind(this),c.onmessage=function(b){if(b.data){var c=JSON.parse(b.data);c.registration?a(this.element).trigger("notificare:didReceiveDeviceToken",c.registration.uuid):c.notification&&(this._refreshBadge(),this._getNotification(c.notification))}}.bind(this),c.onerror=function(a){this._reconnect()}.bind(this),c.onclose=function(a){this._reconnect()}.bind(this)}else this.log("Notificare: Browser doesn't support websockets")},_getPushToken:function(a){var b="";return b=a.subscriptionId?a.subscriptionId:a.endpoint.split("/").pop()},_initWithConfig:function(b,c){a.ajax({type:"GET",url:"/config.json"}).done(function(a){b(a)}.bind(this)).fail(function(a,b,d){c(msg)}.bind(this))},_getApplicationInfo:function(){this.options.appKey&&this.options.appSecret?a.ajax({type:"GET",url:this.options.apiUrl+"/application/info",crossDomain:!0,beforeSend:function(a){a.withCredentials=!0,a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(b){this.applicationInfo=b.application,this.services=b.application.services,a(this.element).trigger("notificare:onReady",b.application),this._handleSession(),this._onURLLocationChanged()}.bind(this)).fail(function(a,b,c){(502==a.status||503==a.status||504==a.status||a.status<0)&&setTimeout(function(){this._getApplicationInfo()}.bind(this),2e3)}.bind(this)):console.warn("Notificare: Please make sure you provide proper application keys")},_sendMessage:function(a){return new Promise(function(b,c){var d=new MessageChannel;d.port1.onmessage=function(a){a.data.error?c(a.data.error):b(a.data)},navigator.serviceWorker.controller.postMessage(JSON.stringify(a),[d.port2])})},registerDevice:function(c){var d=new Date,e=this.options.clientInfo.getOS().name;this.safariPush?e="Safari":this.chromePush&&(e="Chrome");var f="Websocket";this.safariPush?f="WebsitePush":this.chromePush&&(f="GCM"),a.ajax({type:"POST",url:this.options.apiUrl+"/device",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({auth_token:this.options.token,deviceID:c,oldDeviceID:this._getCookie("uuid")&&this._getCookie("uuid")!=c?this._getCookie("uuid"):null,userID:this.options.userId?this.options.userId:null,userName:this.options.username?this.options.username:null,platform:e,osVersion:this.options.clientInfo.getOS().version,sdkVersion:this.options.sdkVersion,appVersion:this.options.appVersion,language:b.navigator.userLanguage||b.navigator.language,deviceString:b.navigator.platform,transport:f,timeZoneOffset:d.getTimezoneOffset()/60*-1}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(b){this._setCookie(c),this._refreshBadge(),a(this.element).trigger("notificare:didRegisterDevice",c)}.bind(this)).fail(function(b,d,e){a(this.element).trigger("notificare:didFailToRegisterDevice",c)}.bind(this))},unregisterDevice:function(b,c){this._getCookie("uuid")&&a.ajax({type:"DELETE",url:this.options.apiUrl+"/device/"+this._getCookie("uuid"),beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(c){this._setCookie(""),localStorage.setItem("badge",0),a(this.element).trigger("notificare:didUpdateBadge",0),b(c)}.bind(this)).fail(function(a,b,d){c("Notificare: Failed to delete a UUID")}.bind(this))},_getNotification:function(b){a.ajax({type:"GET",url:this.options.apiUrl+"/notification/"+b.id,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(c){if(this.allowedNotifications){if(this.options.soundsDir&&b.sound){var d=new Audio(this.options.soundsDir+b.sound);d.load(),d.play()}this.showNotification(c)}this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.notification.Receive",notification:b.notificationId||b.id,userID:this.options.userId||null,deviceID:this._getCookie("uuid")},function(a){},function(a){}),a(this.element).trigger("notificare:didReceiveNotification",b)}.bind(this)).fail(function(a,c,d){setTimeout(function(){this._getNotification(b)}.bind(this),2e3)}.bind(this))},_getChromeNotification:function(b){a.ajax({type:"GET",url:this.options.apiUrl+"/notification/"+b,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(c){if(this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.notification.Receive",notification:b,userID:this.options.userId||null,deviceID:this._getCookie("uuid")},function(a){},function(a){}),a(this.element).trigger("notificare:didReceiveNotification",c.notification),this.allowedNotifications&&this.options.soundsDir&&c.notification.sound){var d=new Audio(this.options.soundsDir+c.notification.sound);d.load(),d.play()}this._refreshBadge()}.bind(this)).fail(function(a,c,d){setTimeout(function(){this._getChromeNotification(b)}.bind(this),2e3)}.bind(this))},_handleClickOnChromeNotification:function(a){var c=this.applicationInfo.websitePushConfig.urlFormatString.replace("%@",a);b.location.replace(c),this._onURLLocationChanged()},_handleActionClickOnChromeNotification:function(b,c){a.ajax({type:"GET",url:this.options.apiUrl+"/notification/"+b,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){this._logNotificationEvents(a),this._refreshBadge(),a&&a.notification&&a.notification.actions&&a.notification.actions.length>0&&a.notification.actions.forEach(function(b){b.label==c&&this._executeAction(a,b)}.bind(this))}.bind(this)).fail(function(a,d,e){setTimeout(function(){this._handleActionClickOnChromeNotification(b,c)}.bind(this),2e3)}.bind(this))},_executeAction:function(c,d){if(d){a(this.element).trigger("notificare:willExecuteAction",c.notification);var e={};"re.notifica.action.Browser"==d.type&&d.target?(b.location.replace(d.target),this._replyOnAction(c,d,e)):"re.notifica.action.Callback"==d.type?d.camera&&d.keyboard&&!d.target?this._executeCameraAndKeyboard(c,d,e):!d.camera||d.keyboard||d.target?d.camera||!d.keyboard||d.target?d.target?this._executeWebHook(c,d,e):this._replyOnAction(c,d,null):this._executeKeyboard(c,d,e):this._executeCamera(c,d,e):"re.notifica.action.Mail"==d.type?(b.location.href="mailto:"+d.target,this._replyOnAction(c,d,e)):"re.notifica.action.Custom"==d.type?(a(this.element).trigger("notificare:shouldPerformActionWithURL",d.target),this._replyOnAction(c,d,e)):a(this.element).trigger("notificare:didFailToExecuteAction",c.notification)}},_replyOnAction:function(b,c,d){this.reply(b.notification._id,c.label,d,function(){a(this.element).trigger("notificare:didExecuteAction",b.notification)},function(){a(this.element).trigger("notificare:didFailToExecuteAction",b.notification)})},_executeWebHook:function(b,c,d){var e,f,g,h,i=c.target.split("?");if(i.length>1)for(e=i[1].split("&"),g=0,h=e.length;h>g;g++)f=e[g].split("="),d[f[0]]=f[1];d.target=i[0],d.label=c.label,b.notification._id&&(d.notificationID=b.notification._id),this._getCookie("uuid")&&(d.deviceID=this._getCookie("uuid")),this.options.userId&&(d.userID=this.options.userId),a.ajax({type:"POST",url:this.options.apiUrl+"/reply/webhook",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify(d),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){this._replyOnAction(b,c,d)}.bind(this)).fail(function(a,e,f){setTimeout(function(){this._executeWebHook(b,c,d)}.bind(this),2e3)}.bind(this))},_executeKeyboard:function(b,c,d){var e=a("<textarea>",{"class":"notificare-text-area"}),f=a("<a>",{"class":"notificare-send",href:"#"}),g=a("<a>",{"class":"notificare-close-modal",href:"#"}),h=a("<div>",{"class":"notificare-modal"}),i=a("<div>",{"class":"notificare-modal-bg"});e.attr("placeholder","Type a reply"),f.text("Send"),g.text("Close"),h.append(e),h.append(f),h.append(g),i.append(h),a("body").append(i),f.click(function(a){a.preventDefault(),d={message:e.val()},this._replyOnAction(b,c,d),i.remove()}.bind(this)),g.click(function(c){c.preventDefault(),a(this.element).trigger("notificare:didNotExecuteAction",b.notification),i.remove()}.bind(this))},_executeCamera:function(c,d,e){var f=a("<canvas>",{"class":"notificare-image"}),g=f.get(0).getContext("2d"),h=a("<video>",{"class":"notificare-camera"}),i=a("<a>",{"class":"notificare-send",href:"#"}),j=a("<a>",{"class":"notificare-cancel",href:"#"}),k=a("<a>",{"class":"notificare-close-modal",href:"#"}),l=a("<a>",{"class":"notificare-capture-image",href:"#"}),m=a("<div>",{"class":"notificare-modal"}),n=a("<div>",{"class":"notificare-modal-bg"});j.text("Cancel"),i.text("Send"),l.text("Take Picture"),k.text("Close"),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(o){h.get(0).src=b.URL.createObjectURL(o),h.get(0).play(),m.append(h),m.append(l),m.append(f),m.append(i),m.append(j),m.append(k),n.append(m),a("body").append(n),f.hide(),i.hide(),j.hide(),l.click(function(a){a.preventDefault(),g.drawImage(h.get(0),0,0,320,180),h.hide(),l.hide(),k.hide(),f.show(),i.show(),j.show(),h.get(0).src="",h.get(0).pause()}.bind(this)),i.click(function(a){a.preventDefault();var b=f.get(0).toDataURL("image/png"),g=this._dataURItoBlob(b);this.uploadFile(g,"reply",function(a){e={media:a},this._replyOnAction(c,d,e)}.bind(this),function(){}.bind(this)),h.get(0).src="",h.get(0).pause(),o.getTracks()[0].stop(),n.remove()}.bind(this)),j.click(function(a){a.preventDefault(),f.hide(),i.hide(),j.hide(),h.show(),l.show(),k.show(),h.get(0).src=b.URL.createObjectURL(o),h.get(0).play()}.bind(this)),k.click(function(b){b.preventDefault(),h.get(0).src="",h.get(0).pause(),o.getTracks()[0].stop(),a(this.element).trigger("notificare:didNotExecuteAction",c.notification),n.remove()}.bind(this))}.bind(this))},_executeCameraAndKeyboard:function(c,d,e){var f=a("<canvas>",{"class":"notificare-image"}),g=a("<textarea>",{"class":"notificare-text-area"}),h=f.get(0).getContext("2d"),i=a("<video>",{"class":"notificare-camera"}),j=a("<a>",{"class":"notificare-send",href:"#"}),k=a("<a>",{"class":"notificare-send",href:"#"}),l=a("<a>",{"class":"notificare-cancel",href:"#"}),m=a("<a>",{"class":"notificare-close-modal",href:"#"}),n=a("<a>",{"class":"notificare-capture-image",href:"#"}),o=a("<div>",{"class":"notificare-modal"}),p=a("<div>",{"class":"notificare-modal-bg"});g.attr("placeholder","Type a reply"),l.text("Cancel"),j.text("Next"),k.text("Send"),n.text("Take Picture"),m.text("Close"),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(q){i.get(0).src=b.URL.createObjectURL(q),i.get(0).play(),o.append(g),o.append(i),o.append(n),o.append(f),o.append(k),o.append(j),o.append(l),o.append(m),p.append(o),a("body").append(p),f.hide(),g.hide(),k.hide(),l.hide(),j.hide(),n.click(function(a){a.preventDefault(),h.drawImage(i.get(0),0,0,320,180),i.hide(),n.hide(),m.hide(),f.show(),j.show(),l.show(),i.get(0).src="",i.get(0).pause()}.bind(this)),j.click(function(a){a.preventDefault();var b=f.get(0).toDataURL("image/png"),c=this._dataURItoBlob(b);this.uploadFile(c,"reply",function(a){e={media:a},g.show(),k.show(),f.hide(),j.hide()}.bind(this),function(){}.bind(this)),i.get(0).src="",i.get(0).pause(),q.getTracks()[0].stop()}.bind(this)),k.click(function(a){a.preventDefault(),e.message=g.val(),this._replyOnAction(c,d,e),p.remove()}.bind(this)),l.click(function(a){a.preventDefault(),f.hide(),k.hide(),l.hide(),j.hide(),g.hide(),i.show(),n.show(),m.show(),i.get(0).src=b.URL.createObjectURL(q),i.get(0).play()}.bind(this)),m.click(function(b){b.preventDefault(),i.get(0).src="",i.get(0).pause(),q.getTracks()[0].stop(),a(this.element).trigger("notificare:didNotExecuteAction",c.notification),p.remove()}.bind(this))}.bind(this))},_dataURItoBlob:function(a){var b,c;b=-1!==a.split(",")[0].indexOf("base64")?atob(a.split(",")[1]):decodeURI(a.split(",")[1]),c=a.split(",")[0].split(":")[1].split(";")[0];for(var d=new Array,e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return new Blob([new Uint8Array(d)],{type:c})},uploadFile:function(b,c,d,e){var f=new FormData;f.append("file",b),a.ajax({type:"POST",url:this.options.apiUrl+"/upload/"+c,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:f,contentType:!1,processData:!1}).done(function(a){d("https://s3-eu-west-1.amazonaws.com/notificare-storage"+a.filename)}.bind(this)).fail(function(a,b,c){e("Notificare: Failed to upload the image")}.bind(this))},isDeviceRegistered:function(){return this._getCookie("uuid")?!0:!1},openNotification:function(b){a.ajax({type:"GET",url:this.options.apiUrl+"/notification/"+b.id,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(b){a(this.element).trigger("notificare:didOpenNotification",b.notification),this._refreshBadge(),this._logNotificationEvents(b)}.bind(this)).fail(function(a,c,d){setTimeout(function(){this.openNotification(b)}.bind(this),2e3)}.bind(this))},showNotification:function(a){if(a&&a.notification&&a.notification.message)if("Notification"in b)try{var c=new Notification(this.applicationInfo.name,{body:a.notification.message,tag:a.notification._id,icon:this.options.awsStorage+this.applicationInfo.websitePushConfig.icon});c.onclick=function(){c.close();var d=this.applicationInfo.websitePushConfig.urlFormatString.replace("%@",a.notification._id);b.location.replace(d),this._onURLLocationChanged()}.bind(this)}catch(d){var c=b.confirm(a.notification.message);if(1==c){var e=this.applicationInfo.websitePushConfig.urlFormatString.replace("%@",a.notification._id);b.location.replace(e),this._onURLLocationChanged()}}else if("webkitNotifications"in b){var c=b.webkitNotifications.createNotification(this.options.awsStorage+this.applicationInfo.websitePushConfig.icon,this.applicationInfo.name,a.notification.message);c.show(),c.onclick=function(){var c=this.applicationInfo.websitePushConfig.urlFormatString.replace("%@",a.notification._id);b.location.replace(c),this._onURLLocationChanged()}.bind(this)}else if("mozNotification"in navigator){var c=navigator.mozNotification.createNotification(this.applicationInfo.name,a.notification.message,this.options.awsStorage+this.applicationInfo.websitePushConfig.icon);c.show(),c.onclick=function(){var c=this.applicationInfo.websitePushConfig.urlFormatString.replace("%@",a.notification._id);b.location.replace(c),this._onURLLocationChanged()}.bind(this)}else{var c=b.confirm(a.notification.message);if(1==c){var e=this.applicationInfo.websitePushConfig.urlFormatString.replace("%@",a.notification._id);b.location.replace(e),this._onURLLocationChanged()}}this._refreshBadge()},_onURLLocationChanged:function(){if(this.applicationInfo&&this.applicationInfo.websitePushConfig&&this.applicationInfo.websitePushConfig.urlFormatString){var a=new RegExp(this.applicationInfo.websitePushConfig.urlFormatString.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1").replace("%@","(\\w+)")),c=a.exec(b.location);c&&c.length>1&&this.openNotification({id:c[1]})}},_logNotificationEvents:function(a){this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.notification.Influenced",notification:a.notification._id,userID:this.options.userId||null,deviceID:this._getCookie("uuid")},function(a){},function(a){}),this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.notification.Open",notification:a.notification._id,userID:this.options.userId||null,deviceID:this._getCookie("uuid")},function(a){this._refreshBadge()}.bind(this),function(a){})},logEvent:function(b,c,d){a.ajax({type:"POST",url:this.options.apiUrl+"/event",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){c(a)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to register log")}.bind(this))},logCustomEvent:function(b,c,d){a.ajax({type:"POST",url:this.options.apiUrl+"/event",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({sessionID:this.uniqueId,type:"re.notifica.event.custom."+b,userID:this.options.userId||null,deviceID:this._getCookie("uuid")}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){c(a)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to register custom event")}.bind(this))},getTags:function(b,c){this._getCookie("uuid")?a.ajax({type:"GET",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/tags",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){b(a.tags)}.bind(this)).fail(function(a,b,d){c("Notificare: Failed to get tags for device")}.bind(this)):c("Notificare: Calling get tags before having a deviceId")},addTags:function(b,c,d){this._getCookie("uuid")?a.ajax({type:"PUT",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/addtags",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({tags:b}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){c(a)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to add tags to device")}.bind(this)):d("Notificare: Calling addTags before registering a deviceId")},removeTag:function(b,c,d){this._getCookie("uuid")?a.ajax({type:"PUT",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/removetag",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({tag:b}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){c(a)}.bind(this)).fail(function(a,b,c){d(null)}.bind(this)):d("Notificare: Calling removeTag before registering a deviceId")},clearTags:function(b,c){this._getCookie("uuid")?a.ajax({type:"PUT",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/cleartags",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:null,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){b(a)}.bind(this)).fail(function(a,b,d){c("Failed to clear device tags.")}.bind(this)):c("Notificare: Calling clearTags before registering a deviceId")},fetchUserData:function(b,c){this._getCookie("uuid")?a.ajax({type:"GET",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/userdata",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){b(a.userData)}.bind(this)).fail(function(a,b,d){c("Notificare: Failed to get user data for device")}.bind(this)):c("Notificare: Calling fetch user data before having a deviceId")},updateUserData:function(b,c,d){this._getCookie("uuid")?a.ajax({type:"PUT",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/userdata",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){c(a)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to update user data for device")}.bind(this)):d("Notificare: Calling update user data before registering a deviceId")},fetchDoNotDisturb:function(b,c){this._getCookie("uuid")?a.ajax({type:"GET",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/dnd",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){b(a.dnd)}.bind(this)).fail(function(a,b,d){c("Notificare: Failed to get dnd for device")}.bind(this)):c("Notificare: Calling fetch dnd before having a deviceId")},updateDoNotDisturb:function(b,c,d,e){this._getCookie("uuid")?b&&c?a.ajax({type:"PUT",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/dnd",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({start:b,end:c}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){d(a)}.bind(this)).fail(function(a,b,c){e("Notificare: Failed to update dnd for device")}.bind(this)):e("Notificare: Calling update dnd without a start and end time"):e("Notificare: Calling update dnd before registering a deviceId")},clearDoNotDisturb:function(b,c){this._getCookie("uuid")?a.ajax({type:"PUT",url:this.options.apiUrl+"/device/"+this._getCookie("uuid")+"/cleardnd",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:null,contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){b(a)}.bind(this)).fail(function(a,b,d){c("Notificare: Failed to clear dnd for device")}.bind(this)):c("Notificare: Calling clear dnd before registering a deviceId")},startLocationUpdates:function(a,b){this._getCookie("uuid")?this.applicationInfo.services&&this.applicationInfo.services.locationServices?navigator.geolocation?navigator.geolocation.watchPosition(function(c){var d=JSON.parse(localStorage.getItem("position"));d.latitude!=c.coords.latitude||d.longitude!=c.coords.longitude?this._getDeviceCountry(c,function(d){this.updateLocation(c,d.country,function(d){this._getNearestRegions(c,function(b){this._handleRegions(c,b),a(d)}.bind(this),function(a){b("Notificare: Failed to get nearest regions")})}.bind(this),function(){b("Notificare: Failed to update device location")})}.bind(this)):this._getNearestRegions(c,function(b){this._handleRegions(c,b),this.log("Notificare: Skipped location update, nothing changed"),a(JSON.parse(localStorage.getItem("position")))}.bind(this),function(a){b("Notificare: Failed to get nearest regions")})}.bind(this),function(a){switch(a.code){case a.PERMISSION_DENIED:b("Notificare: User denied the request for Geolocation");break;case a.POSITION_UNAVAILABLE:b("Notificare: Location information is unavailable");break;case a.TIMEOUT:b("Notificare: The request to get user location timed out");break;case a.UNKNOWN_ERROR:b("Notificare: An unknown location error occurred")}},this.options.geolocationOptions):b("Notificare: Browser does not support Geolocation API"):b("Notificare: Your account does not support Location Services"):b("Notificare: Calling startLocationUpdates before registering a deviceId")},stopLocationUpdates:function(){this.applicationInfo.services&&this.applicationInfo.services.locationServices?navigator.geolocation&&navigator.geolocation.clearWatch():this.log("Notificare: Your account does not support Location Services")},updateLocation:function(b,c,d,e){a.ajax({type:"PUT",
url:this.options.apiUrl+"/device/"+this._getCookie("uuid"),beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({latitude:b.coords.latitude,longitude:b.coords.longitude,country:c}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){localStorage.setItem("position",JSON.stringify({accuracy:isNaN(b.coords.accuracy)?null:b.coords.accuracy,altitude:isNaN(b.coords.altitude)?null:b.coords.altitude,altitudeAccuracy:isNaN(b.coords.altitudeAccuracy)?null:b.coords.altitudeAccuracy,heading:isNaN(b.coords.heading)?null:b.coords.heading,speed:isNaN(b.coords.speed)?null:b.coords.speed,latitude:b.coords.latitude,longitude:b.coords.longitude,country:c,timestamp:b.timestamp})),d(JSON.parse(localStorage.getItem("position")))}.bind(this)).fail(function(a,b,c){e(null)}.bind(this))},fetchInbox:function(b,c){this._getCookie("uuid")?a.ajax({type:"GET",url:this.options.apiUrl+"/notification/inbox/fordevice/"+this._getCookie("uuid"),beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){b(a.inboxItems)}.bind(this)).fail(function(a,b,d){c("Notificare: Failed to get the inbox")}.bind(this)):c("Notificare: Calling fetchInbox before having a deviceId")},openInboxItem:function(a){this.openNotification({id:a.notification})},markAsRead:function(a,b,c){this.logEvent({sessionID:this.uniqueId,type:"re.notifica.event.notification.Open",notification:a.notification,userID:this.options.userId||null,deviceID:this._getCookie("uuid")},function(a){this._refreshBadge(),b(a)},function(a){c("Notificare: Failed to mark inbox item as read")})},clearInbox:function(b,c){this._getCookie("uuid")?a.ajax({type:"DELETE",url:this.options.apiUrl+"/notification/inbox/fordevice/"+this._getCookie("uuid"),beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){this._refreshBadge(),b(a)}.bind(this)).fail(function(a,b,d){c("Notificare: Failed to clear the inbox")}.bind(this)):c("Notificare: Calling clearInbox before having a deviceId")},removeFromInbox:function(b,c,d){this._getCookie("uuid")?a.ajax({type:"DELETE",url:this.options.apiUrl+"/notification/inbox/"+b._id,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){this._refreshBadge(),c(a)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to remove item from inbox")}.bind(this)):d("Notificare: Calling removeFromInbox before having a deviceId")},_refreshBadge:function(){this._getCookie("uuid")?a.ajax({type:"GET",url:this.options.apiUrl+"/notification/inbox/fordevice/"+this._getCookie("uuid"),data:{since:(new Date).getTime()},beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(b){localStorage.setItem("badge",b.unread),a(this.element).trigger("notificare:didUpdateBadge",b.unread)}.bind(this)).fail(function(b,c,d){a(this.element).trigger("notificare:didUpdateBadge",localStorage.getItem("badge"))}.bind(this)):errors("Notificare: Refreshing Badge before having a deviceId")},_handleRegions:function(b,c){a.each(c,function(c,d){var e=JSON.parse(localStorage.getItem("regions"));if(this._calculateDistanceBetweenPoints(b,d)<=d.distance)-1==a.inArray(d._id,e)&&this._trigger("re.notifica.trigger.region.Enter",d,function(a){e.push(d._id),localStorage.setItem("regions",JSON.stringify(e))},function(a){});else{var f=a.inArray(d._id,e);f>-1&&this._trigger("re.notifica.trigger.region.Exit",d,function(a){e.splice(f,1),localStorage.setItem("regions",JSON.stringify(e))},function(a){})}}.bind(this))},_getNearestRegions:function(b,c,d){a.ajax({type:"GET",url:this.options.apiUrl+"/region/bylocation/"+b.coords.latitude+"/"+b.coords.longitude,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:null}).done(function(a){c(a.regions)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to retrieve nearest regions")}.bind(this))},_calculateDistanceBetweenPoints:function(a,b){var c=a.coords.latitude,d=b.geometry.coordinates[1],e=a.coords.longitude,f=b.geometry.coordinates[0],g=6371e3,h=c*Math.PI/180,i=d*Math.PI/180,j=(d-c)*Math.PI/180,k=(f-e)*Math.PI/180,l=Math.sin(j/2)*Math.sin(j/2)+Math.cos(h)*Math.cos(i)*Math.sin(k/2)*Math.sin(k/2),m=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),n=g*m;return n},_getDeviceCountry:function(b,c){a.ajax({type:"GET",url:"https://maps.googleapis.com/maps/api/geocode/json",data:{latlng:b.coords.latitude+","+b.coords.longitude,sensor:!1}}).done(function(a){if("OK"===a.status&&a.results&&a.results.length>0){var b;for(i=0;i<a.results[0].address_components.length;i++)for(j=0;j<a.results[0].address_components[i].types.length;j++)"country"==a.results[0].address_components[i].types[j]&&(b=a.results[0].address_components[i].short_name);c({country:b})}else c({country:null})}.bind(this)).fail(function(a,b,d){c({country:null})}.bind(this))},reply:function(b,c,d,e,f){this._getCookie("uuid")?a.ajax({type:"POST",url:this.options.apiUrl+"/reply",beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({userID:this.options.userId,deviceID:this._getCookie("uuid"),notification:b,data:d,label:c}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){e(a)}.bind(this)).fail(function(a,b,c){f("Notificare: Failed to register reply")}.bind(this)):f("Notificare: Calling reply before registering a deviceId")},fetchAssets:function(b,c,d){this.applicationInfo.services.storage?a.ajax({type:"GET",url:this.options.apiUrl+"/asset/forgroup/"+b,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(b){var d=[];a.each(b.assets,function(a,b){d.push({title:b.title,description:b.description,url:"https://push.notifica.re/asset/file/"+b.key,metaData:b.metaData,button:b.button})}.bind(this)),c(d)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to get assets for this group")}.bind(this)):d("Notificare: This is a add-on service, please activate in order to use this method")},fetchPass:function(b,c,d){this.applicationInfo.services.passbook?a.ajax({type:"GET",url:this.options.apiUrl+"/pass/forserial/"+b,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this)}).done(function(a){c(a.pass)}.bind(this)).fail(function(a,b,c){d("Notificare: Failed to get pass for this serial")}.bind(this)):d("Notificare: This is a add-on service, please activate in order to use this method")},_trigger:function(b,c,d,e){a.ajax({type:"POST",url:this.options.apiUrl+"/trigger/"+b,beforeSend:function(a){a.setRequestHeader("Authorization","Basic "+btoa(this.options.appKey+":"+this.options.appSecret))}.bind(this),data:JSON.stringify({region:c._id,deviceID:this._getCookie("uuid")}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(a){d(a)}.bind(this)).fail(function(a,b,c){e("Notificare: Failed to trigger region")}.bind(this))}},a.fn[f]=function(b){if("string"==typeof arguments[0]){var c,g=arguments[0],h=Array.prototype.slice.call(arguments,1);return this.each(function(){if(!a.data(this,f)||"function"!=typeof a.data(this,f)[g])throw new Error("Method "+g+" does not exist on "+f+".jquery.js");var b=a.data(this,f);c=b[g].apply(b,h)}),c!==d?c:this}return"object"!=typeof b&&b?void 0:this.each(function(){a.data(this,f)||a.data(this,f,new e(this,b))})}}(jQuery,window,document);