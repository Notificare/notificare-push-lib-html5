<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>My App</title>
		<meta name="viewport" content="width=device-width">
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="apple-touch-icon.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="apple-touch-icon.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="apple-touch-icon.png">
		<link rel="apple-touch-icon-precomposed" href="apple-touch-icon.png">
		<link rel="shortcut icon" href="favicon.ico">
		<link rel="manifest" href="/manifest.json" />

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<style>
			.remove-from-inbox{
				float: right;
				right: -14px;
				top: 20px;
			}
		</style>
	</head>
	<body>
		<section id="myapp">
			<div class="container">
				<!-- Static navbar -->
				<div class="navbar navbar-default" role="navigation">
					<div class="container-fluid">
						<div class="navbar-header">
							<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
								<span class="sr-only">Toggle navigation</span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
							</button>
							<a class="navbar-brand" href="http://notifica.re">Project name</a>
						</div>
					</div><!--/.container-fluid -->
				</div>
				<div class="jumbotron">
					<h1>My Banner</h1>
					<p>Quickly bootstrap your html project</p>
					<p>
						<div class="btn-group">
							<button class="btn btn-default btn-lg dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								Inbox <span id="badge" class="badge"></span> <span class="caret"></span>
							</button>
							<ul id="inbox-list" class="dropdown-menu">
								<li id="divider" role="separator" class="divider"></li>
								<li><a id="clear-inbox" href="#">Clear Inbox</a></li>
							</ul>
						</div>

					</p>
				</div>
			</div> <!-- /container -->
		</section>
		<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.9/ua-parser.min.js"></script>
        <script src="/resources/js/notificare.jquery.js"></script>
		<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
		<script>


			$(document).ready(function(){

				var options = {
					appVersion: '1.0',
					appKey: '1798db7916a4cf53bea00499d6d0b15ca5c8554e25c4fe56cfaea1b9b937764f',
					appSecret: '302d94942a158d4d493020e30ab44fa92770d7d41a436e405e85e4509c9ac854',
					allowSilent: true,
					soundsDir: '/resources/sounds/',
					serviceWorker: "/resources/js/push-worker.js",
					geolocationOptions: {
						timeout: 60000,
						enableHighAccuracy: true,
						maximumAge: Infinity
					}
				};

				var instance = $('#myapp').notificare(options);

				$("#myapp").bind("notificare:onReady", function(event, data) {
					instance.notificare("registerForNotifications");

				});

				$("#myapp").bind("notificare:didReceiveDeviceToken", function(event, data) {
					//instance.notificare("userId","userID");
					//instance.notificare("username","userName");
					instance.notificare("registerDevice",data);
				});

				$("#myapp").bind("notificare:didRegisterDevice", function(event, data) {
					//Here it's safe to register tags

					instance.notificare("getTags", function(tags){
						console.log(tags);
					}, function(error){
						console.log(error);
					});

					instance.notificare("startLocationUpdates", function(data){
						console.log(data);
					}, function(error){
						console.log(error);
					});

					instance.notificare("fetchInbox", function(inboxItems){

						refreshInbox(inboxItems);

					}, function(error){
						console.log(error);
					});
				});

				$("#myapp").bind("notificare:didFailToRegisterDevice", function(event, data) {
					instance.notificare("registerDevice", data);


				});

				$("#myapp").bind("notificare:didReceiveNotification", function(event, data) {

					instance.notificare("fetchInbox", function(inboxItems){

						refreshInbox(inboxItems);

					}, function(error){
						console.log(error);
					});
				});

				$("#myapp").bind("notificare:didOpenNotification", function(event, data) {
					instance.notificare("log", data);
				});

				$("#myapp").bind("notificare:didUpdateBadge", function(event, data) {
					instance.notificare("log", 'didUpdateBadge: ' + data);
					if (data > 0) {
						$("#badge").text(data);
						$("#badge").show();
					} else {
						$("#badge").hide();
					}
				});

				function refreshInbox(inboxItems){

					$(".open-inbox-message").parent().remove();

					$.each( inboxItems.reverse(), function( key, value ) {
						if (value.opened) {
							$("#inbox-list").prepend('<li><a href="' + value._id + '" class="remove-from-inbox"><span class="glyphicon glyphicon-remove"></span></a><a class="open-inbox-message" href="' + value.notification + '">' + value.message + '</a></li>');
						} else {
							$("#inbox-list").prepend('<li><a href="' + value._id + '" class="remove-from-inbox"><span class="glyphicon glyphicon-remove"></span></a><a class="open-inbox-message" href="' + value.notification + '"><strong>' + value.message + '</strong></a></li>');
						}

					});
				}

				$("#clear-inbox").click(function(){
					instance.notificare("clearInbox", function(msg){
						instance.notificare("fetchInbox", function(inboxItems){

							refreshInbox(inboxItems);

						}, function(error){
							console.log(error);
						});
					}, function(error){
						console.log(error);
					});
				}.bind(this));


				$(document).on('click', '.open-inbox-message', function (){
					instance.notificare("openInboxItem", {notification: $(this).attr('href')});

					setTimeout(function(){
						instance.notificare("fetchInbox", function(inboxItems){

							refreshInbox(inboxItems);

						}, function(error){
							console.log(error);
						});
					}, 1000);

					return false;
				});


				$(document).on('click', '.remove-from-inbox', function (){

					instance.notificare("removeFromInbox", $(this).attr('href'), function(msg){

						instance.notificare("fetchInbox", function(inboxItems){

							refreshInbox(inboxItems);

						}, function(error){
							console.log(error);
						});

					}, function(error){
						console.log(error);
					});

					return false;
				});

			});
		</script>
	</body>
</html>
